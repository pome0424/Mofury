<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex,nofollow">
<title>Mofuryにログイン</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{ box-sizing:border-box; }

body{
  margin:0;
  background:#fdf6f7; /* 白っぽい背景 */
  font-family:sans-serif;
}

.container{
  max-width:420px;
  margin:0 auto;
  padding:24px;
}

.card{
  background:#ffffff;
  border-radius:24px;
  padding:24px;
}

.mofurin{
  display:flex;
  gap:12px;
  align-items:flex-start;
  margin-bottom:16px;
}

.mofurin img{
  width:64px;
  height:64px;
}

.speech{
  background:#f4e7ea;
  border-radius:16px;
  padding:12px;
  font-size:14px;
}

input{
  width:100%;
  padding:14px;
  margin-top:12px;
  border-radius:16px;
  border:1px solid #eee;
  font-size:14px;
}

button{
  width:100%;
  padding:14px;
  margin-top:12px;
  border:none;
  border-radius:20px;
  background:#aacc9b;
  font-size:15px;
  font-weight:bold;
  cursor:pointer;
  pointer-events:auto;
  position:relative;
  z-index:5;
  -webkit-appearance:none;
  appearance:none;
}

button:active{ opacity:0.85; }

.code{
  margin-top:12px;
  font-size:26px;
  letter-spacing:4px;
  text-align:center;
  background:#f8f1f2;
  border-radius:16px;
  padding:12px;
}

.hidden{ display:none; }

#error{
  color:#c00;
  margin-top:12px;
  font-size:14px;
}
</style>
</head>

<body>
<div class="container">
  <div class="card">

    <div class="mofurin">
      <img id="icon" src="characters/mofurin_hudan.png" alt="もふりん">
      <div class="speech" id="speech">
        Scratchのユーザー名を入力してね！
      </div>
    </div>

    <!-- STEP 1 -->
    <div id="step1">
      <input id="username" placeholder="Scratchユーザー名">
      <button type="button" id="getCodeBtn">認証コードを取得</button>
    </div>

    <!-- STEP 2 -->
    <div id="step2" class="hidden">
      <p>このコードをScratchのコメントに貼ってね</p>
      <div class="code" id="code"></div>
      <button type="button" id="verifyBtn">コメントした！</button>
    </div>

    <p id="error"></p>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* =====================
     設定（必ず自分のに）
     ===================== */
  const PROJECT_ID = "ruyvyedvdzyedafehhoz";        // https://XXXX.supabase.co の XXXX
  const ANON_KEY  = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1eXZ5ZWR2ZHp5ZWRhZmVoaG96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NjM1NDEsImV4cCI6MjA4MTQzOTU0MX0.tr4v3-bmIEyZ_DRMXSpxdx-7ZGAGc2GRcSJaXKuJFSs";    // anon public key
  
  const supabase = window.supabase.createClient(
    `https://${PROJECT_ID}.supabase.co`,
    ANON_KEY
  );
  
  /* DOM */
  const usernameInput = document.getElementById("username");
  const step2 = document.getElementById("step2");
  const codeBox = document.getElementById("code");
  const errorBox = document.getElementById("error");
  const icon = document.getElementById("icon");
  const speech = document.getElementById("speech");
  
  /* =====================
     認証コード取得
     ===================== */
  document.getElementById("getCodeBtn").addEventListener("click", async () => {
    const username = usernameInput.value.trim();
    if(!username){
      errorBox.innerText = "ユーザー名を入力してね";
      return;
    }
  
    errorBox.innerText = "";
  
    try{
      const res = await fetch(
        `https://${PROJECT_ID}.supabase.co/functions/v1/scratch-auth-handler`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${ANON_KEY}`
          },
          body: JSON.stringify({
            type: "generateCode",
            username
          })
        }
      );
  
      const data = await res.json();
      if(!res.ok || !data.code){
        throw new Error(data.error || "認証コード取得に失敗しました");
      }
  
      codeBox.innerText = data.code;
      step2.classList.remove("hidden");
  
      icon.src = "characters/mofurin_egao.png";
      speech.innerText = "コメントしたら押してね！";
  
    }catch(e){
      errorBox.innerText = e.message;
    }
  });
  
  /* =====================
     コメント確認 → ログイン
     ===================== */
  document.getElementById("verifyBtn").addEventListener("click", async () => {
    const username = usernameInput.value.trim();
    const code = codeBox.innerText;
  
    errorBox.innerText = "";
  
    try{
      const res = await fetch(
        `https://${PROJECT_ID}.supabase.co/functions/v1/scratch-auth-handler`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${ANON_KEY}`
          },
          body: JSON.stringify({
            type: "verifyComment",
            username,
            code
          })
        }
      );
  
      const data = await res.json();
      if(!res.ok || !data.access_token){
        throw new Error(data.error || "認証に失敗しました");
      }
  
      await supabase.auth.setSession({
        access_token: data.access_token,
        refresh_token: data.refresh_token
      });
  
      /* 成功 → ホームへ */
      window.location.href = "index.html";
  
    }catch(e){
      errorBox.innerText = e.message;
    }
  });
});
</script>
</body>
</html>
