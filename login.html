<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex,nofollow">
<title>Mofuryにログイン</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{
  box-sizing:border-box;
}

body{
  margin:0;
  background:#fdf6f7; /* ← 白っぽく */
  font-family:sans-serif;
}

.container{
  max-width:420px;
  margin:0 auto;
  padding:24px;
}

.card{
  background:#ffffff;
  border-radius:24px;
  padding:24px;
}

.mofurin{
  display:flex;
  gap:12px;
  align-items:flex-start;
  margin-bottom:16px;
}

.mofurin img{
  width:64px;
  height:64px;
}

.speech{
  background:#f4e7ea;
  border-radius:16px;
  padding:12px;
  font-size:14px;
}

input{
  width:100%;
  padding:14px;
  margin-top:12px;
  border-radius:16px;
  border:1px solid #eee;
  font-size:14px;
}

button{
  width:100%;
  padding:14px;
  margin-top:12px;

  border:none;
  border-radius:20px;

  background:#aacc9b;
  font-size:15px;
  font-weight:bold;

  cursor:pointer;
  pointer-events:auto;
  position:relative;
  z-index:10;

  -webkit-appearance:none;
  appearance:none;
}

button:active{
  opacity:0.85;
}

.code{
  margin-top:12px;
  font-size:26px;
  letter-spacing:4px;
  text-align:center;
  background:#f8f1f2;
  border-radius:16px;
  padding:12px;
}

.hidden{
  display:none;
}

#error{
  color:#c00;
  margin-top:12px;
}
</style>
</head>

<body>
<div class="container">
  <div class="card">

    <div class="mofurin">
      <img id="icon" src="characters/mofurin_hudan.png">
      <div class="speech" id="speech">
        Scratchのユーザー名を入力してね！
      </div>
    </div>

    <!-- STEP 1 -->
    <div id="step1">
      <input id="username" placeholder="Scratchユーザー名">
      <button type="button" onclick="getCode()">認証コードを取得</button>
    </div>

    <!-- STEP 2 -->
    <div id="step2" class="hidden">
      <p>このコードをScratchのコメントに貼ってね</p>
      <div class="code" id="code"></div>
      <button type="button" onclick="verify()">コメントした！</button>
    </div>

    <p id="error"></p>

  </div>
</div>

<script>
const PROJECT_ID = "ruyvyedvdzyedafehhoz";
const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1eXZ5ZWR2ZHp5ZWRhZmVoaG96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NjM1NDEsImV4cCI6MjA4MTQzOTU0MX0.tr4v3-bmIEyZ_DRMXSpxdx-7ZGAGc2GRcSJaXKuJFSs";

const supabase = window.supabase.createClient(
  `https://${PROJECT_ID}.supabase.co`,
  ANON_KEY
);

async function getCode(){
  const username = document.getElementById("username").value.trim();
  if(!username) return;

  document.getElementById("error").innerText = "";

  try{
    const res = await fetch(
      `https://${PROJECT_ID}.supabase.co/functions/v1/scratch-auth-handler`,
      {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":`Bearer ${ANON_KEY}`
        },
        body:JSON.stringify({ type:"generateCode", username })
      }
    );

    const data = await res.json();
    if(!res.ok) throw new Error(data.error || "通信エラー");

    document.getElementById("code").innerText = data.code;
    document.getElementById("step2").classList.remove("hidden");

    document.getElementById("icon").src="characters/mofurin_egao.png";
    document.getElementById("speech").innerText="コメントしたら押してね！";

  }catch(e){
    document.getElementById("error").innerText = e.message;
  }
}

async function verify(){
  const username = document.getElementById("username").value.trim();
  const code = document.getElementById("code").innerText;

  try{
    const res = await fetch(
      `https://${PROJECT_ID}.supabase.co/functions/v1/scratch-auth-handler`,
      {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":`Bearer ${ANON_KEY}`
        },
        body:JSON.stringify({ type:"verifyComment", username, code })
      }
    );

    const data = await res.json();
    if(!res.ok) throw new Error(data.error || "認証失敗");

    await supabase.auth.setSession({
      access_token:data.access_token,
      refresh_token:data.refresh_token
    });

    location.href="index.html";

  }catch(e){
    document.getElementById("error").innerText = e.message;
  }
}
</script>
</body>
</html>
